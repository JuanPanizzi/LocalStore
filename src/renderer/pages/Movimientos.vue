<template>
<section class="p-5 bg-[#0F172A]">

    <DataTable  v-model:filters="filters" filterDisplay="menu" :value="dataMovimientos" paginator :rows="5" tableStyle="min-width: 50rem"
    showGridlines style="max-width: 90vw" class="mx-auto">
        <!-- <Column field="numero_movimiento" header="ID"></Column> -->
        <!-- <Column field="fecha" header="FECHA"></Column> -->
        <Column header="Date" filterField="date" dataType="date" style="min-width: 10rem">
                <template #body="{ data }">
                    {{data.fecha }}
                </template>
                <template #filter="{ filterModel }">
                    <DatePicker v-model="filterModel.value" dateFormat="mm/dd/yy" placeholder="mm/dd/yyyy" />
                </template>
            </Column>

        <Column field="material_repuesto" header="MATERIAL / REPUESTO"></Column>
        <Column field="marca" header="MARCA"></Column>
        <Column field="modelo_serie" header="MODELO"></Column>
        <Column field="tipo_movimiento" header="MOVIMIENTO"></Column>
        <Column field="origen" header="ORIGEN"></Column>
        <Column field="destino" header="DESTINO"></Column>
        <Column field="cantidad" header="CANTIDAD"></Column>
        <Column field="permiso_trabajo_asociado" header="PT ASOCIADO"></Column>
        <Column field="informe_asociado" header="INFORME ASOCIADO"></Column>
        <Column field="orden_trabajo_asociada" header="OT ASOCIADA"></Column>
        <Column field="remito" header="REMITO"></Column>
        <Column field="numero_almacenes" header="N° ALMACENES"></Column>
        <Column field="observaciones" header="OBSERVACIONES"></Column>
    </DataTable>
    
    <div class="mt-10 flex justify-end mx-auto" style="max-width: 90vw">
        <FileUpload mode="basic" name="file" chooseLabel="Importar Excel" accept=".xlsx,.xls" auto="true"
        @select="seleccionarExcel" />
    </div>
    <Toast />
</section>
</template>
<script>
import Button from 'primevue/button';
import Column from 'primevue/column';
import DataTable from 'primevue/datatable';
import { defineComponent, onMounted, ref } from 'vue';
import Toast from 'primevue/toast';
import { useToast } from 'primevue/usetoast';
import { useMovimientos} from '../composables/useMovimientos';
import FileUpload from 'primevue/fileupload';
import { FilterMatchMode, FilterOperator } from '@primevue/core/api';


export default defineComponent({
    name: 'Movimientos',
    components: {
        Button,
        Column,
        DataTable,
        Toast,
        FileUpload
    },

    setup() {
      const filters = ref({
        date: { operator: FilterOperator.AND, constraints: [{ value: null, matchMode: FilterMatchMode.DATE_IS }] },
      });
        const dataMovimientos = ref(null);
        const toast = useToast()
        const { importarExcel, guardarExcelMovimientos, obtenerMovimientos } = useMovimientos();
       
        const seleccionarExcel = async (event) => {
        const response = await importarExcel(event);
        
        if(response.success){
            dataMovimientos.value = response.data;
            toast.add({ severity: "success", summary: "Éxito", detail: "Datos cargados correctamente.", life: 3000 });
        }else {
        
            switch(response.message){

                case 'Faltan columnas':
                    toast.add({ severity: "error", summary: `Error`, detail: "Faltan columnas en el archivo excel, intente nuevamente.", life: 5000 });
                break;
                case 'Fechas inválidas':
                toast.add({ severity: "error", summary: `Error`, detail: "Se encontraron fechas inválidas en el archivo excel, intente nuevamente.", life: 5000 });

                break;
            }
        }
    };


        onMounted(async ()=>{

            const response = await obtenerMovimientos();

            if(response.success){
                dataMovimientos.value = response.data;
            }else{
                toast.add({ severity: 'error', summary: 'Error', detail: 'Error al obtener el registro de movimientos, intente nuevamente', life: 3000 });
            }

        });

        return {
            seleccionarExcel,
            importarExcel,
            dataMovimientos,
            guardarExcelMovimientos,
            obtenerMovimientos,
            filters

            
        }
    }
})

</script>